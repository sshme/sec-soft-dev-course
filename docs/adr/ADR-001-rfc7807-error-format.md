# ADR-001: RFC 7807 Error Format

Дата: 2025-10-22
Статус: Accepted

## Context

Текущая реализация API возвращает ошибки в произвольном формате (`{"error": {"code": "...", "message": "..."}}`), что затрудняет стандартизацию обработки ошибок на клиентской стороне. Отсутствует:
- Единый формат для всех типов ошибок (валидация, бизнес-логика, HTTP-ошибки)
- Корреляционные идентификаторы для трейсинга запросов
- Стандартизированные типы ошибок (`type` URI)
- Маскирование чувствительных деталей для продакшна

RFC 7807 (Problem Details for HTTP APIs) предоставляет стандартизированный формат для описания ошибок в HTTP API с полями `type`, `title`, `status`, `detail`, `instance`.

## Decision

Принимаем RFC 7807 как стандарт для всех ошибочных ответов API:

1. **Обязательные поля:**
   - `type` (string): URI идентификатор типа проблемы (default: `about:blank`)
   - `title` (string): Краткое человекочитаемое описание типа проблемы
   - `status` (integer): HTTP статус код
   - `detail` (string): Детальное объяснение конкретного случая
   - `correlation_id` (string): UUID для трейсинга запроса

2. **Опциональные поля:**
   - `instance` (string): URI конкретного запроса
   - Дополнительные поля специфичные для типа ошибки

3. **Маскирование деталей:**
   - В продакшн-режиме системные ошибки возвращают generic сообщения
   - Stack traces и внутренние детали не раскрываются
   - Correlation ID позволяет искать детали в логах

4. **Content-Type:** `application/problem+json`

5. **Маппинг ошибок:**
   - `ValidationError` (422) → `type: /errors/validation`
   - `NotFound` (404) → `type: /errors/not-found`
   - `BusinessLogicError` (400) → `type: /errors/business-logic`
   - `InternalServerError` (500) → `type: /errors/internal`

## Consequences

### Плюсы:
- Стандартизация: клиенты могут использовать единую логику обработки ошибок
- Трейсинг: `correlation_id` связывает клиентский запрос с логами на бэкенде
- Безопасность: контроль раскрытия чувствительной информации
- Совместимость: RFC 7807 широко поддерживается в инструментах и библиотеках
- Расширяемость: можно добавлять кастомные поля без нарушения стандарта

### Минусы:
- Breaking change: требует обновления всех клиентов API
- Overhead: дополнительные поля увеличивают размер ответа (~50-100 байт)
- Complexity: требует централизованного error handler и маппинга ошибок

### Влияние:
- **DX:** Улучшается за счет предсказуемого формата ошибок
- **Performance:** Минимальное (генерация UUID ~1-2μs, сериализация JSON незначительна)
- **Security:** Существенно улучшается контроль утечки информации

## Links

- [RFC 7807 Specification](https://tools.ietf.org/html/rfc7807)
- NFR-03 (Error Handling Requirements)
- `tests/test_errors.py::test_rfc7807_contract` - тесты контракта
- `app/errors.py` - реализация problem details handler
