# ADR-005: Authorization (RBAC + Ownership)

Дата: 2025-11-02
Статус: Accepted

## Context

Сервис работает с пользовательскими данными (например, highlights) и должен гарантировать строгую изоляцию между пользователями, а также управлять административными операциями. Требуется понятная, проверяемая и расширяемая модель авторизации.

## Decision

Принимаем модель RBAC, дополняемую проверкой владения ресурсом (ownership) и опциональными scope’ами.

1. Роли
   - Минимальный набор: `user` (по умолчанию), `admin` (расширенные операции).
   - Принцип наименьших привилегий: выдача роли `admin` строго ограничена, действия — аудируются.

2. Политика по умолчанию
   - Default deny: доступ запрещен, если явно не разрешен.
   - Доступ к ресурсам возможен при совпадении `resource.owner_id == token.sub` и наличии соответствующих scope/ролей.

3. Scope/Permissions
   - Для тонкой настройки вводятся scope’ы, пример: `highlights:read`, `highlights:write`, `admin:read`, `admin:write`.
   - Scope’ы кодируются в JWT (`scope` или `scopes`). Отсутствие нужного scope → 403 Forbidden.

4. Владелец ресурса
   - Каждая сущность в хранилище имеет `owner_id`.
   - Все запросы выборки/модификации фильтруются по `owner_id` на уровне запросов (не полагаться на фильтрацию на клиенте).

5. Поведение ответов
   - При отсутствии прав на чтение конкретного ресурса возвращать 404 (resource not found), чтобы не раскрывать факт существования (anti-enumeration).
   - При отсутствии глобальных прав (роль/scope) на операцию — 403 (forbidden). Ошибки в формате RFC 7807 (ADR-001).

6. Точки расширения
   - Возможность добавления ABAC-правил (атрибуты ресурса/запроса) в будущем.
   - Политики оформляются функциями/зависимостями, легко тестируемыми unit-тестами.

7. Техническая реализация
   - FastAPI зависимости: `require_auth()`, `require_scopes([...])`, `require_role('admin')`, `require_owner(resource)`. Проверки объединяются кратко и явно в маршрутах.
   - Запрет «скрытых» пропусков: линтер/ревью правят все новые эндпойнты с явными зависимостями авторизации.

8. Наблюдаемость и аудит
   - Аудит-лог всех отказов 403/404 с `correlation_id` (без данных ресурса).
   - Метрики успешных/ошибочных авторизаций по эндпойнтам и ролям.

## Consequences

### Плюсы
- Прозрачная и минималистичная модель (RBAC + ownership), предсказуемая в тестах.
- Устойчивость к перечислению ресурсов (404 при отсутствии доступа).
- Легко расширяется scope’ами и/или ABAC при росте требований.

### Минусы
- Требует дисциплины при добавлении новых эндпойнтов (обязательные зависимости).
- Необходима консистентность хранения `owner_id` и фильтрации на уровне запросов.

### Влияние
- Безопасность: изоляция данных между пользователями; админ-операции — под контролем.
- DX: явные зависимости упрощают ревью и тестирование.

## Links

- ADR-001 (RFC 7807 Errors), ADR-004 (Authentication), ADR-003 (Secrets Management)
- OWASP ASVS 4.0.3 — V4 Access Control
- `app/security/authorization.py` — реализация политик
- `tests/test_authz.py` — тесты авторизации
