# ADR-004: Authentication (JWT Bearer)

Дата: 2025-11-02
Статус: Accepted

## Context

Приложению требуется надежная аутентификация для защиты API. Требования:
- Статлес-модель без серверных сессий, соответствующая 12-Factor.
- Совместимость с существующей системой секретов (ADR-003) и форматом ошибок (ADR-001).
- Возможность безопасной ротации ключей без простоя.
- Устойчивость к утечке токенов, повторному использованию (replay) и брутфорсу.

## Decision

Принимаем JWT Bearer Tokens (RFC 6750) для аутентификации.

1. Протокол и формат
   - HTTP `Authorization: Bearer <jwt>`.
   - Формат токена — JWT (JWS) с алгоритмом `HS256`.
   - Секрет подписи берется из `SECRET_KEY` (см. ADR-003), поддерживается одновременная проверка текущего и предыдущего ключа при ротации.

2. Виды токенов
   - Access Token: TTL = 15 минут, используется для доступа к API.
   - Refresh Token: TTL = 7 дней, используется только для обновления Access Token.
   - Оба токена содержат обязательные клеймы: `iss`, `aud`, `sub`, `iat`, `exp`, `jti`; опционально `nbf`, `scope` (пространство через пробел) или `scopes` (массив).

3. Клеймы и идентификация
   - `sub` — идентификатор пользователя (строка UUID/ULID).
   - `jti` — уникальный идентификатор токена для управления отзывом.
   - Часы сервера: допуск рассинхронизации (clock skew) ±60 секунд.

4. Хранение токенов
   - Для браузеров: Refresh Token — `HttpOnly`, `Secure`, `SameSite=Lax` cookie; Access Token — в памяти приложения (не в localStorage).
   - Для non-browser клиентов: оба токена передаются в заголовках/теле протоколом клиента, хранение — на стороне клиента.

5. Обновление и отзыв
   - Endpoint обмена: `POST /auth/token` (issue/refresh), rate limit 5 req/min на `sub`+IP.
   - Ведение denylist для Refresh Token по `jti` (отзыв при логауте/компрометации).
   - Access Token не ревокируется централизованно (короткая жизнь); при необходимости допускается кэш denylist ≤ TTL access токена.

6. Ротация ключей (см. ADR-003)
   - Проверка подписи проводится против `SECRET_KEY` и `SECRET_KEY_PREV` (если задан).
   - После ротации выпуск токенов ведется новым ключом, старые валидируются ограниченное время (≤ 24 часа).

7. Ошибки и безопасность
   - Ошибки аутентификации возвращаются в RFC 7807 (`application/problem+json`):
     - 401 Unauthorized → `type: /errors/unauthorized` (invalid/expired token, missing token).
     - 400 Bad Request → `type: /errors/token` (malformed token).
   - Детали причин не раскрывать в продакшне; использовать `correlation_id` для трассировки (ADR-001).

8. Наблюдаемость
   - Аудит-лог событий: вход, обновление токена, логаут, неуспешные попытки (без включения секретов/сырых токенов).
   - Метрики: доля 401/400 по причинам, среднее время выпуска/проверки токенов, количество refresh-операций.

## Consequences

### Плюсы
- Статлес и горизонтально масштабируемо, не требует серверных сессий.
- Простая интеграция с ADR-003 для ротации секретов.
- Четкая модель TTL и ограниченная область компрометации Access Token.

### Минусы
- Требуется аккуратное клиентское хранение Refresh Token.
- Необходим denylist для отзывов refresh-токенов и защита endpoint’ов обмена.
- HS256 требует надежного секрета и дисциплины управления доступом к нему.

### Влияние
- Производительность: проверка подписи HS256 — ~микросекунды; оверхед минимален.
- DX: единый механизм для CLI/браузера; требуется вспомогательная клиентская библиотека.

## Links

- RFC 6750 (Bearer Token Usage)
- OWASP Cheat Sheet: JSON Web Token
- ADR-001 (RFC 7807 Errors), ADR-003 (Secrets Management)
- `app/security/jwt.py` — реализация
- `tests/test_authn.py` — тесты аутентификации
