# Нефункциональные требования (NFR) — свод по ADR-001…005

Ниже приведены 10 проверяемых NFR, вытекающих из всех ADR:
- ADR-001 (RFC 7807 ошибки)
- ADR-002 (валидация ввода и загрузки файлов)
- ADR-003 (управление секретами)
- ADR-004 (аутентификация)
- ADR-005 (авторизация)

## Ошибки и наблюдаемость

### NFR-01: Ошибки в формате RFC 7807
- Требование: все 4xx/5xx — `application/problem+json` с `type`, `title`, `status`, `detail`, `correlation_id` (опц. `instance`).
- Приемка:
  - Любая ошибка в тестах контрактов соответствует схеме RFC 7807.
  - В продакшне не раскрываются stack trace/секреты; `correlation_id` присутствует.

### NFR-02: Корреляция и логирование
- Требование: `correlation_id` генерируется на входе, прокидывается до логов/ответов; чувствительные данные маскируются.
- Приемка:
  - ≥ 99.9% запросов в логах содержат `correlation_id`.
  - Логи не содержат секретов или токенов в открытом виде.

## Ввод данных и медиа

### NFR-03: Валидация ввода
- Требование: ограничения на поля (`text` ≤ 2000, `source` ≤ 500, теги ≤ 10, lowercase, trim); строгая схема для query; enum-ы.
- Приемка:
  - Негативные кейсы возвращают 422 с `type: /errors/validation`.
  - Санитизация удаляет HTML/скрипты, где разметка не требуется.

### NFR-04: Безопасные загрузки файлов
- Требование: размер ≤ 5_000_000 байт, таймаут ≤ 30 сек; только `image/png`,`image/jpeg`; проверка magic bytes; UUID-ключи; основное хранилище — S3-совместимый бакет (`S3_BUCKET`) с серверным шифрованием; временные файлы сохраняются только в `TMP_DIR` для валидации перед загрузкой в S3; запрет symlink и каноникализация путей применяются только к `TMP_DIR`.
- Приемка:
  - Несоответствие сигнатур/типа/размера — отклоняется; негативные тесты проходят.
  - Временные файлы создаются строго внутри `TMP_DIR` и удаляются после успешной загрузки; объекты в S3 имеют сервер‑сторонние UUID‑ключи и корректный `Content-Type`.

## Секреты и конфигурация

### NFR-05: Управление секретами и ротация
- Требование: секреты не в VCS; dev — `.env` (локально), prod — env/Secret Manager; валидация обязательных секретов на старте; маскирование в логах/`repr`;
  ротация без простоя (двойные ключи: текущий + предыдущий), аудит обращений.
- Приемка:
  - Отсутствие обязательного секрета → ошибка старта.
  - Ротация не приводит к 5xx и не ломает выпуск/проверку токенов в окно совместимости.

## Идентификация и доступ

### NFR-06: Аутентификация (JWT)
- Требование: JWT Bearer `HS256`; Access TTL 15 мин, Refresh TTL 7 дней; clock skew ±60 сек; refresh-эндпойнт с RL (5/мин на sub+IP); denylist по `jti` для Refresh; в браузере Refresh — `HttpOnly`+`Secure`+`SameSite=Lax` cookie.
- Приемка:
  - Неверный/просроченный/многократно использованный токен → 401 (`/errors/unauthorized`), без утечки деталей.
  - Проверка подписи работает с `SECRET_KEY` и опционально `SECRET_KEY_PREV`.

### NFR-07: Авторизация (RBAC + владение)
- Требование: default deny; роли `user`/`admin`; scope-ы; доступ к сущностям только если `owner_id == sub`; чтение чужих ресурсов — 404, отсутствие глобального права — 403.
- Приемка:
  - Все list/get запросы фильтруются по `owner_id` на уровне хранилища.
  - Unit/интеграционные тесты на 403/404 покрывают основные эндпойнты.

## Производительность и устойчивость

### NFR-08: Производительность и устойчивость
- Требование: проверка JWT ≤ 1 ms p95; выдача токена ≤ 5 ms p95; upload-валидация добавляет ≤ 5 ms p95; система выдерживает ≥ 500 rps/узел; ротация секретов без простоя; RL: `POST /highlights` ≤ 10 req/min/IP, upload ≤ 3/min/пользователь.
- Приемка:
  - Нагрузочные тесты подтверждают целевые p95 и отсутствие роста 5xx при ротации.
  - Срабатывает rate limiting согласно заданным лимитам.

## Инженерные практики и контракт API

### NFR-09: Стандарты проекта и безопасность разработки
- Требование: обязательные проверки в CI — линтинг (ruff, isort, black), тесты с покрытием ≥ 60%, SAST (bandit) и аудит зависимостей (pip-audit/safety); зависимости пинятся/обновляются безопасно (renovate/constraints); сборка воспроизводима.
- Приемка:
  - Merge в `main` возможен только при зелёном CI и покрытии ≥ 60%.
  - Отсутствуют уязвимости уровня High/Critical в зависимостях; при наличии — сборка падает.
  - Отчёты линтеров/SAST доступны как артефакты; SBOM публикуется в релизах.

### NFR-10: Контракт API методов и стабильность
- Требование: стабильный контракт `/v1` с полной спецификацией OpenAPI; идемпотентность `PUT`/`DELETE`, поддержка `Idempotency-Key` для `POST` создания; детерминированная пагинация (cursor по `created_at,id`), совместимость назад в пределах major; политика деприкации ≥ 60 дней.
- Приемка:
  - Спецификация OpenAPI покрывает все эндпойнты/схемы; валидация контрактов проходит в CI.
  - Повтор `PUT/DELETE` не изменяет состояние, `POST` с тем же `Idempotency-Key` не создаёт дубликаты.
  - Пагинация воспроизводима при конкурентных вставках; e2e тесты фиксируют порядок.

## Связанные документы
- ADR-001 — RFC 7807 Error Format
- ADR-002 — Input Validation & File Uploads
- ADR-003 — Secrets Management
- ADR-004 — Authentication (JWT)
- ADR-005 — Authorization (RBAC + Ownership)
